{% extends 'layout/base.html' %}
{% block title %}Printer Configuration{% endblock %}

{% block extra_css %}
<style>
    .form-switch .form-check-input {
        width: 3.5em;
        height: 1.75em;
    }
</style>
{% endblock %}

{% block content %}
<div class="container" style="max-width: 900px;">
    <h1 class="display-4 text-center mb-4">Printer Configuration</h1>
    <p class="text-center text-muted">Configure the data to be sent to the default Bluetooth printer when an object is detected.</p>

    <form id="printer-config-form">
        <!-- Master Toggle Switch -->
        <div class="card mb-4">
            <div class="card-body d-flex justify-content-between align-items-center">
                <h3 class="mb-0"><i class="bi bi-printer-fill"></i> Automatic Printing</h3>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" role="switch" id="printer-enabled-switch" name="enabled">
                </div>
            </div>
        </div>

        <!-- Data Configuration -->
        <div class="card mb-4">
            <div class="card-header fs-4">Data Payload</div>
            <div class="card-body">
                <p class="text-muted">This data is sent with every print job. For example: `PartNo:12345`</p>
                <div class="row g-3">
                    <div class="col-md-6">
                        <h5>Field 1</h5>
                        <div class="mb-2">
                            <label for="var1" class="form-label">Field 1 Name (e.g., "PartNo:")</label>
                            <input type="text" id="var1" name="var1" class="form-control virtual-keyboard-input">
                        </div>
                        <div>
                            <label for="val1" class="form-label">Field 1 Value (e.g., "12345")</label>
                            <input type="text" id="val1" name="val1" class="form-control virtual-keyboard-input">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h5>Field 2</h5>
                        <div class="mb-2">
                            <label for="var2" class="form-label">Field 2 Name (e.g., "QRCode:")</label>
                            <input type="text" id="var2" name="var2" class="form-control virtual-keyboard-input">
                        </div>
                        <div>
                            <label for="val2" class="form-label">Field 2 Value (e.g., "ABC-XYZ")</label>
                            <input type="text" id="val2" name="val2" class="form-control virtual-keyboard-input">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Delay Configuration -->
        <div class="card mb-4">
            <div class="card-header fs-4">Timing</div>
            <div class="card-body">
                <label for="delay_ms" class="form-label">Print Delay (in milliseconds)</label>
                <input type="number" id="delay_ms" name="delay_ms" class="form-control virtual-keyboard-input" placeholder="e.g., 500">
                <small class="text-muted">Adds a delay after an object is detected before the print command is sent.</small>
            </div>
        </div>

        <!-- Save Button -->
        <div class="d-grid">
            <button type="submit" class="btn btn-primary btn-lg">Save Configuration</button>
        </div>
    </form>
    <div id="message-area" class="mt-3"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function showMessage(msg, isSuccess) {
        const area = document.getElementById('message-area');
        const alertClass = isSuccess ? 'alert-success' : 'alert-danger';
        area.innerHTML = `<div class="alert ${alertClass}" role="alert">${msg}</div>`;
        setTimeout(() => { area.innerHTML = ''; }, 3000);
    }

    const form = document.getElementById('printer-config-form');

    // ## FIX: Load existing settings from the correct API endpoint when the page loads
    document.addEventListener('DOMContentLoaded', () => {
        fetch('/api/get_printer_config')
            .then(res => {
                if (!res.ok) {
                    throw new Error('Network response was not ok');
                }
                return res.json();
            })
            .then(config => {
                form.elements['enabled'].checked = config.enabled;
                form.elements['delay_ms'].value = config.delay_ms;
                form.elements['var1'].value = config.var1;
                form.elements['val1'].value = config.val1;
                form.elements['var2'].value = config.var2;
                form.elements['val2'].value = config.val2;
            })
            .catch(error => {
                console.error('Error fetching printer config:', error);
                showMessage('Could not load printer settings.', false);
            });
    });

    // ## FIX: Handle form submission to save settings to the correct API endpoint
    form.addEventListener('submit', e => {
        e.preventDefault();
        
        const settings = {
            enabled: form.elements['enabled'].checked,
            delay_ms: form.elements['delay_ms'].value,
            var1: form.elements['var1'].value,
            val1: form.elements['val1'].value,
            var2: form.elements['var2'].value,
            val2: form.elements['val2'].value,
        };

        fetch('/api/save_printer_config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(settings)
        })
        .then(res => res.json())
        .then(data => {
            showMessage(data.message, data.success);
        });
    });
</script>
{% endblock %}