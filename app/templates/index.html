{% extends 'layout/base.html' %}
{% block title %}Dashboard{% endblock %}

{% block extra_css %}
<style>
    /* Custom styles for the dashboard cards */
    .dashboard-card { border: none; color: white; }
    .dashboard-card .card-title { color: rgba(255, 255, 255, 0.7); }
    .dashboard-card .display-1, .dashboard-card .display-4 { font-weight: bold; }
    .shortcut-btn { flex-grow: 1; }
</style>
{% endblock %}

{% block content %}
<div class="row g-4 justify-content-center">
    <div class="col-lg-11 col-xl-10">
        <!-- Live Status Cards -->
        <div class="row g-4 text-center">
            <!-- Live Count -->
            <div class="col-md-6 col-lg-4">
                <div class="card p-3 h-100 dashboard-card" style="background-color: #007bff;">
                    <h3 class="card-title">LIVE COUNT</h3>
                    <p class="display-1" id="live_count">0 / 0</p>
                </div>
            </div>
            <!-- Gate Status -->
            <div class="col-md-6 col-lg-4">
                <div class="card p-3 h-100 dashboard-card" style="background-color: #6f42c1;">
                    <h3 class="card-title">GATE STATUS</h3>
                    <p class="display-1" id="gate_status">--</p>
                </div>
            </div>
            <!-- Batches Completed -->
            <div class="col-md-6 col-lg-4">
                <div class="card p-3 h-100 dashboard-card" style="background-color: #198754;">
                    <h3 class="card-title">BATCHES COMPLETED</h3>
                    <p class="display-1" id="batches_completed">0</p>
                </div>
            </div>
            <!-- IR Sensor Status -->
            <div class="col-md-6 col-lg-4">
                <div class="card p-3 h-100 dashboard-card" style="background-color: #dc3545;">
                    <h3 class="card-title">IR SENSOR</h3>
                    <p class="display-4" id="ir_status">--</p>
                </div>
            </div>
            <!-- Last Printed Data -->
            <div class="col-lg-8">
                <div class="card p-3 h-100 dashboard-card" style="background-color: #6c757d;">
                    <h3 class="card-title">LAST PRINTED DATA</h3>
                    <p class="display-4 font-monospace" id="last_printed_payload" style="word-wrap: break-word;">N/A</p>
                </div>
            </div>
        </div>
        
        <!-- System Status -->
        <div class="card mt-4">
            <div class="card-body p-3 text-center">
                <h3 class="card-title text-muted">SYSTEM STATUS</h3>
                <div id="system_status" class="mt-2">
                    <span class="badge fs-4 bg-secondary">Initializing</span>
                </div>
            </div>
        </div>

        <!-- Active Configuration Card -->
        <div class="card mt-4">
            <div class="card-body p-4">
                <h2 class="card-title mb-4"><i class="bi bi-info-circle-fill"></i> Active Configuration</h2>
                <div class="d-flex justify-content-between align-items-center fs-4">
                    <span>Current Batch Target:</span>
                    <strong class="font-monospace" id="display_batch_target">--</strong>
                </div>
                <hr>
                <div class="d-flex justify-content-between align-items-center fs-4">
                    <span>Current Gate Wait Time:</span>
                    <strong class="font-monospace" id="display_gate_wait_time">-- sec</strong>
                </div>
            </div>
        </div>

        <!-- Set New Configuration Card -->
        <div class="card mt-4">
            <div class="card-body p-4">
                <h2 class="card-title mb-4"><i class="bi bi-pencil-square"></i> Set New Configuration</h2>
                <form id="configForm">
                    <!-- NEW: Shortcut Buttons -->
                    <div class="mb-3">
                        <label class="form-label">Batch Target Shortcuts</label>
                        <div class="d-flex flex-wrap gap-2" id="shortcut-container">
                            <button type="button" class="btn btn-outline-info shortcut-btn" data-value="50">50</button>
                            <button type="button" class="btn btn-outline-info shortcut-btn" data-value="80">80</button>
                            <button type="button" class="btn btn-outline-info shortcut-btn" data-value="100">100</button>
                            <button type="button" class="btn btn-outline-info shortcut-btn" data-value="150">150</button>
                            <button type="button" class="btn btn-outline-info shortcut-btn" data-value="200">200</button>
                            <button type="button" class="btn btn-outline-info shortcut-btn" data-value="250">250</button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="batch_target" class="form-label">New Batch Target</label>
                            <input type="number" class="form-control form-control-lg virtual-keyboard-input" id="batch_target" name="batch_target" placeholder="e.g., 20" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="gate_wait_time" class="form-label">New Gate Wait Time (s)</label>
                            <input type="number" class="form-control form-control-lg virtual-keyboard-input" id="gate_wait_time" name="gate_wait_time" placeholder="e.g., 10" required>
                        </div>
                    </div>
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-2">
                        <button id="resetBtn" type="button" class="btn btn-danger btn-lg">Reset Live Count</button>
                        <button type="submit" class="btn btn-primary btn-lg">Update Configuration</button>
                    </div>
                </form>
                <div id="message" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function updateDashboardStatus() {
        fetch('/api/status')
            .then(res => res.json())
            .then(data => {
                // Update all the new cards
                document.getElementById('live_count').textContent = `${data.object_count} / ${data.batch_target}`;
                document.getElementById('gate_status').textContent = data.gate_status.toUpperCase();
                document.getElementById('ir_status').textContent = data.ir_status.toUpperCase();
                document.getElementById('batches_completed').textContent = data.batches_completed;
                document.getElementById('last_printed_payload').textContent = data.last_printed_payload;

                // Gate status color
                document.getElementById('gate_status').className = data.gate_status === 'Open' ? 'display-1 text-white' : 'display-1 text-warning';
                
                // IR sensor status color
                document.getElementById('ir_status').className = data.ir_status === 'Blocked' ? 'display-4 text-warning' : 'display-4 text-white';

                // System status badge
                const systemStatusEl = document.getElementById('system_status');
                let badgeClass = 'bg-secondary';
                if (data.system_status.includes('Ready')) badgeClass = 'bg-success';
                if (data.system_status.includes('Counting')) badgeClass = 'bg-info text-dark';
                if (data.system_status.includes('Waiting') || data.system_status.includes('Closing')) badgeClass = 'bg-warning text-dark';
                systemStatusEl.innerHTML = `<span class="badge fs-4 ${badgeClass}">${data.system_status}</span>`;
                
                // Update the read-only display card
                document.getElementById('display_batch_target').textContent = data.batch_target;
                document.getElementById('display_gate_wait_time').textContent = `${data.gate_wait_time} sec`;
            });
    }

    // NEW: Event listener for shortcut buttons
    document.getElementById('shortcut-container').addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') {
            const value = e.target.dataset.value;
            document.getElementById('batch_target').value = value;
        }
    });

    // Form submission listener is unchanged
    document.getElementById('configForm').addEventListener('submit', function(e) { /* ... */ });
    // Reset button listener is unchanged
    document.getElementById('resetBtn').addEventListener('click', function() { /* ... */ });

    // Initial load and interval
    document.addEventListener('DOMContentLoaded', () => {
        updateDashboardStatus();
        setInterval(updateDashboardStatus, 1000);
    });
</script>
{% endblock %}